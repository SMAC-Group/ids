---
title: "Homework"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Syllabus}
  %\VignetteEncoding{UTF-8}
---

# Homework 1


<div class="alert alert-info">
  <strong>Important:</strong> To submit your homework share your GitHub repository with **stephaneguerrier** and **munsheet** by the deadline (i.e. 09/14/17 at 4PM).  Do not modify your homework after the deadline. We will grade the most recent (~ 4PM) portion of your RMarkdown file. 
</div>


The objectives of this homework assignment are the following

- Build your own RMarkdown document; 
- Master different aspects of RMarkdown syntax;
- Become familiar with GitHub as collaborative tool.

To start, create a (perferably private) GitHub repository for your group, and name it **stat297hw1**. Once again, make sure to add **munsheet** and **stephaneguerrier** as collaborators. This project **must** be done using GitHub and respect the following requirements:

- All members of the group must `commit` at least once. 
- All commit messages must be reasonably `clear` and `meaningful`.   
- Your GitHub repository much include at least one `issue` containing some form of TO DO list. 

In your repository create a file called \textbf{HW1.Rmd} providing an HTML output with the theme `cerulean` and syntax highlighting `tango`. This file should contain the following elements:

1. A "title" section which should *at least* include:
    - A title (e.g. Homework 1) 
    - The authors 
    - The date (think of using `Sys.time()`)

2. A section called "Introduction" where you provide a short summary of the structure of your homework. Moreover, record a short video to introduce your group and include it in your R Markdown document.

3. A section called "Group Members". This sections should have one sub-section for each group member in your team. For example, a group with three members should have three biographies in total. Each of these sub-sections (named after each group member) should include small biographies containing *at least* the following elements:

    - A picture of your choice (preferably of yourself). Make sure to include a caption for this image. 
    -  A paragraph describing your favorite hobby as well as one interesting fact about yourself.
    - Your favorite quote in blockquote format and be sure to reference your quote using BibTex.
    - A table having two columns (first column containing the classes you are following this semester; second column containing the time of these classes).

4. A section called "R Markdown Syntax", where you will demonstrate your R Markdown skills! In this section make sure to: 

    - Show an example where the chunk option `cache = T` leads to a misleading answer. This example must be different from the one presented in the textbook.
    - Simulate 100 random samples from a standard normal distribution using the function `rnorm()`. Store these 100 values in a vector called `x`. Then, compute the empirical median, mean and variance of `x`. Are these results different from 0, 0 and 1 (their respective theoretical values)? Is this result surprising? Justify your answer. 
    - Include a graph showing the histogram of `x` (make sure to include a caption to this figure), this can be done in R using the function `hist()`.
    - Include the equation below: 
\[
	\begin{aligned}
			 \mathbb{E} \left[ \text{var} \left\{
                             \boldsymbol{v}_1\left(
                               \hat{\boldsymbol{\theta}},n\right) \big|
                             \hat{\boldsymbol{\theta}} \right\}  \right] 
&=
                         \text{var} \left\{ \mathbf{v}_1\left(
                             \boldsymbol{\theta}_0,n\right)  \right\}  +
                         \mathbb{E} \left[\mathcal{O}_p\left\{
{\bf D}_1(\boldsymbol{\theta}^*,n)(\hat{\boldsymbol{\theta}} - \boldsymbol{\theta}_{0}), 
\dots,
{\bf D}_p(\boldsymbol{\theta}^*,n)(\boldsymbol{\theta} - \boldsymbol{\theta}_{0})
\right\}\right]\\
			&= \text{var} \left\{ \mathbf{v}_1\left( \boldsymbol{\theta}_0,n\right)  \right\}  + \mathcal{O}\left(n^{-2}\right).
	\end{aligned}
\]

    - Include the following *in-line* equation: $\mathbf{A} \equiv \left[a_{i,j}\right]_{i,j = 1, \ldots, p}$.
    - Include the following text in blue\textbf{blue}: <font color="blue">"Vérité dans un temps, erreur dans un autre.", Charles de Montesquieu</font>
    - Include a "More info" button with hide/unhide functionality such as:
    <button data-toggle="collapse" data-target="#demo">More info</button>
<div id="demo" class="collapse">
Some additional info... :)
</div> 
    - Include a "color box" such as the one below:
    
    <div class="alert alert-success">
  <strong>Some important Info:</strong> something
</div>

5. A "References" section that contains all the references used in your document.


# Homework 

<div class="alert alert-danger">
  <strong>Important:</strong> To submit your homework share your GitHub repository with **stephaneguerrier** and **munsheet** by the deadline, 4PM 10/13/2017.  **Do not modify your homework after the deadline**. We will grade the version of your RMarkdown file that's closest to 4PM 10/13/2017.
</div>

The objectives of this homework assignment are the following:

- Learn how program effectively using if/else and iterations statements; 
- Become familiar with using data frame objects and mapping packages;
- Constructing a portfolio;
- Become familiar with GitHub and using it as a collaborative tool.

To start, create a (perferably private) GitHub repository for your group, and name it **stat297hw2**. Be sure to add **munsheet** and **stephaneguerrier** as collaborators. 

This project **must** be done using GitHub and respect the following requirements:

- Each member of the group must `commit` at least once. 
- All commit messages must be reasonably `clear` and `meaningful`.   
- Your GitHub repository must include at least one `issue` containing some form of a TO DO list. 

## Fizz Buzz  

Write a program that prints the numbers from 1 to 1000. But for multiples of three print "Fizz" instead of the number and for the multiples of five print "Buzz". For numbers which are multiples of both three and five print "FizzBuzz".

An example output would be: 

```{r, eval = FALSE}
1, 2, Fizz, 4, Buzz, Fizz, 7, 8, Fizz, Buzz, 11, Fizz, 13, 14, Fizz Buzz, 16, 17, Fizz, 19, Buzz, Fizz, 22, 23, Fizz, Buzz, 26, Fizz, 28, 29, Fizz Buzz, 31, 32, Fizz, 34, Buzz, Fizz, ...
```

## Map 

Using the same tools we used in class, create a simple map to represent current standing in the Big Ten football conference. More specifically, the goal of this problem is to reproduce as closely as possible the map below:


```{r, message=FALSE, warning=FALSE, cache=TRUE, echo=FALSE}
library(maps)
library(ggmap)
library(rvest)

# Define webpage
big10 = read_html("http://www.bigten.org/library/stats/fb-confsked.html#standings")

# Get uni names
big10 %>% 
    html_nodes(".b1gfbstats:nth-child(9) td:nth-child(1) , .b1gfbstats:nth-child(6) td:nth-child(1)") %>% 
    html_text() -> uni_name
uni_name = paste(uni_name,"University")

# Find uni locations
uni_coord = data.frame(geocode(uni_name))

# Get win rate
big10 %>% 
    html_nodes("td:nth-child(7)") %>%
    html_text() -> uni_wp
uni_coord$wp = 100*as.numeric(uni_wp[1:length(uni_name)])

# Get division
uni_coord$conf = rep(c("East Division","West Division"), each = length(uni_name)/2)
```

```{r, echo=FALSE, fig.height=5, fig.width=7, cache=TRUE, fig.align='center'}
# Select states
all_states = map_data("state")
selected.states = subset(all_states, region %in% c("south dakota",
      "kansas","west virginia","new jersey","maryland","minnesota",
      "nebraska","pennsylvania","illinois","indiana","iowa",
      "michigan", "ohio", "wisconsin", "missouri"))

# Make graph
my.graph = ggplot(legend=FALSE)
my.graph = my.graph + geom_polygon(data = selected.states, 
            aes(x=long, y=lat, group = group), 
            colour="grey80", fill="grey95")
my.graph = my.graph + geom_point(data = uni_coord,
            aes(lon,lat, colour = conf, size = wp))
my.graph = my.graph  + theme_bw() + xlab("Longitude") +
           ylab("Latitude") + labs(title = paste("Big 10 Conference - as of", Sys.Date()))
my.graph = my.graph + scale_colour_discrete(name="Division",
           labels = c("East","West"))
my.graph = my.graph + scale_size_area(name="Win rate [%]")
my.graph
```

Note that the code below was used to download the data needed for this graph:


```{r, cache = TRUE, eval=FALSE}
library(maps)
library(ggmap)
library(rvest)

# Define webpage
big10 = read_html("http://www.bigten.org/library/stats/fb-confsked.html#standings")

# Get uni names
big10 %>% 
    html_nodes(".b1gfbstats:nth-child(9) td:nth-child(1) , .b1gfbstats:nth-child(6) td:nth-child(1)") %>% 
    html_text() -> uni_name
uni_name = paste(uni_name,"University")

# Find uni locations
uni_coord = data.frame(geocode(uni_name))

# Get win rate
big10 %>% 
    html_nodes("td:nth-child(7)") %>%
    html_text() -> uni_wp
uni_coord$wp = 100*as.numeric(uni_wp[1:length(uni_name)])

# Get division
uni_coord$conf = rep(c("East Division","West Division"), each = length(uni_name)/2)
```

## 3D-random walks

In this problem you will program a three-dimensional random walk. For this purpose we will consider a three-dimensional space where we let $\mathbf{X}_0 = [0 \;\; 0\;\; 0]^T$ denote the starting point of our process. Suppose that there exist a sequence of random variables $U_1, \cdots, U_B$ such $U_t \stackrel{iid}{\sim} \mathcal{U}(0,1)$. Then, we let the position at time $t$ (where $1 \leq t \leq B$) be given by

\[
\mathbf{X}_t = \mathbf{X}_{t - 1} + \mathbf{f}(U_t), 
\]

where

\[
\mathbf{f}(U_t) = \left\{
	\begin{array}{ll}
		[\phantom{-}1 \; \,\;\phantom{-}0 \; \,\;\phantom{-}0]^T  & \mbox{if } U_t \leq a_1 \\
		[     -1      \; \,\;\phantom{-}0 \; \,\;\phantom{-}0]^T  & \mbox{if } U_t \in (a_1, \, a_2] \\
		[\phantom{-}0 \; \,\;\phantom{-}1 \; \,\;\phantom{-}0]^T  & \mbox{if } U_t \in (a_2, \, a_3] \\
		[\phantom{-}0 \; -1       \; \,\;\phantom{-}0]^T  & \mbox{if } U_t \in (a_3, \, a_4] \\
		[\phantom{-}0 \; \,\;\phantom{-}0 \; \,\;\phantom{-}1]^T  & \mbox{if } U_t \in (a_4, \, a_5] \\
		[\phantom{-}0 \; \,\;\phantom{-}0 \; -1]^T  & \mbox{if } U_t > a_5. \\
	\end{array}
\right.
\]

So for example, if we consider $B = 2$, $a_i = \frac{i}{6}$, $U_1 = 0.12$ and $U_2 = 0.81$ then we have

\[\mathbf{X}_1 = \mathbf{X}_0 + \mathbf{f}(U_t = 0.12) = \left[
\begin{matrix}
0\\
0\\
0\\
\end{matrix}\right] + \left[
\begin{matrix}
-1\\
\phantom{-}0\\
\phantom{-}0\\
\end{matrix}\right] = \left[
\begin{matrix}
-1\\
\phantom{-}0\\
\phantom{-}0\\
\end{matrix}\right]. \]

and

\[\mathbf{X}_2 = \mathbf{X}_1 + \mathbf{f}(U_t = 0.81) = \left[
\begin{matrix}
-1\\
\phantom{-}0\\
\phantom{-}0\\
\end{matrix}\right] + \left[
\begin{matrix}
0\\
0\\
1\\
\end{matrix}\right] = \left[
\begin{matrix}
-1\\
\phantom{-}0\\
\phantom{-}1\\
\end{matrix}\right]. \]

```{r randomwalk, echo=FALSE}
step_direction <- function(U, a){
  if (U <= a[1]){return(c(1,0,0))}
  if (U > a[1] & U <= a[2]){return(c(-1,0,0))}
  if (U > a[2] & U <= a[3]){return(c(0,1,0))}
  if (U > a[3] & U <= a[4]){return(c(0,-1,0))}
  if (U > a[4] & U <= a[5]){return(c(0,0,1))}
  if (U > a[5]){return(c(0,0,-1))}
}

RW3D <- function(B = 500, a = 1:5/6, seed = 1982){
  set.seed(seed)
  Ut <- runif(B, 0, 1)
  Xt <- matrix(0, 3, B+1)
  for (i in 1:B){
    Xt[,(i+1)] <- Xt[,i] + step_direction(Ut[i], a)
  }
  class(Xt) <- "RW3D"
  Xt
}

plot.RW3D <- function(Xt, add_final = TRUE){
  B <- ncol(Xt) - 1
  x0 <- Xt[1, 1:B]
  x1 <- Xt[1, 2:(B+1)]
  y0 <- Xt[2, 1:B]
  y1 <- Xt[2, 2:(B+1)]
  z0 <- Xt[3, 1:B]
  z1 <- Xt[3, 2:(B+1)]
  
  
  cols = hcl(h = seq(15, 375, length = 3), l = 65, c = 100)[1:2]
  
  segments3D(x0 = x0, y0 = y0, z0 = z0, 
              x1 = x1, y1 = y1, z1 = z1,
              xlab = " ", ylab = " ", zlab = " ",
              bty = "g", ticktype = "detailed", phi = 5)
  
  scatter3D(0, 0, 0, pch = 20, cex = 2, add = TRUE, col = cols[1])
  
  if (add_final){
    scatter3D(x1[B], y1[B], z1[B], pch = 20, cex = 2, add = TRUE, col = cols[2])
  }
}
```

- **(a)** Using the same idea, simulate a three-dimensional random walk with $B = 10^4$, $a_i = \frac{i}{6}$ and with $U_t$ being obtained as follows

```{r}
B <- 10^4
set.seed(1982)
Ut <- runif(B)
head(Ut)
```

Therefore, $U_t$ corresponds to the *t*-th element `Ut`. Using the characteristics, show that

\[
X_B = \left[\begin{matrix}
-6\\
\phantom{-}22\\
\phantom{-}26\\
\end{matrix}\right],
\]

and provide a graphical respresentation of your random walk. For example, you can produce a graph similar to the one below which is based on the function `segments3D` from the `plot3D` package. Note that the red and blue points indicate, respectively the starting and end points of the random walk.

```{r, echo=FALSE, fig.height=5, fig.width=6, fig.align='center'}
library(plot3D)
Xt = RW3D(B = 10^3)
plot(Xt)
```

- **(b)** Repeat what you have in part **(a)** but with $B = 10^5$, $a_i = 0.99 \frac{i}{6}$ and with $U_t$ being obtained as follows

```{r}
B <- 10^5
set.seed(2000)
Ut <- runif(B)
head(Ut)
```

You should obtain

\[
X_B = \left[\begin{matrix}
\phantom{-}142\\
-133\\
-899\\
\end{matrix}\right],
\]

and produce a graph similar to:

```{r, echo=FALSE, fig.height=5, fig.width=6, fig.align='center', cache=TRUE}
library(plot3D)
Xt = RW3D(B = 10^5, a = 0.99*(1:5/6), seed = 2000)
plot(Xt)
```

- **(c) - bonus:** Show that using the setting of part **(b)** we have:

\[\mathbb{E} \left[ X_B \right] = \left[\begin{matrix}
0\\
0\\
-0.01 B\\
\end{matrix}\right]. \]

Does this result make sense given the end of the process simulated in part **(b)**

- **(d) - bonus** Create a video to show how a random walk changes in time. Here is an example:

```{r, echo=FALSE}
htmltools::includeHTML("RW3D.html") 
```

```{r, eval = FALSE, echo=FALSE}
library(animation)
ani.options(interval=.05)
B = 500
Xt = RW3D(B = B)

saveHTML({
  for (i in 1:(B-1)) {
    Yt = Xt[,1:(i+1)]
    class(Yt) = "RW3D"
    plot(Yt)
  }
}, htmlfile = "RW3D.html")
```



## Construct a portfolio

Suppose that you are working in an investment firm company as a quantitative analyst. Your boss gives you the task of creating a portfolio for one of your clients. The client wants to find the portfolio with the smallest variance that satisfies the following constraints:
  
- Invest exactly $1,000,000.
- Only invest in stocks that are in the S&P500 index.
- Spend less than $100 in execution.

Your execution fees (i.e. the cost of buying shares) are given by $C_i = \max \left(\$40, \$ 0.0001 \cdot X_i \right)$ for each transaction where $X_i$ represent the amount of money you wish to invest in stock $i$. For example, if you want to invest 30% and 70% in stocks A and B your total cost would be

\[
  \text{Cost} = C_1 + C_2 = \max \left(\$40, \$ 0.0001 \cdot 0.3 \cdot  10^6  \right) + \max \left(\$40, \$ 0.0001 \cdot 0.7 \cdot  10^6  \right) = \max(\$40, \$30) + \max(\$40, \$70) = \$40 + \$70 = \$110.
  \]

Note that $\sum_i X_i = \$1,000,000$. Therefore, your boss want you to compute all possible portfolios that satify the client's constraints, represent them graphically as (for example) in the graph below and find the weight of the best (i.e. minimum variance) portfolio. The list of all current S&P 500 stock's tickers is by

```{r, echo=FALSE, fig.align='center', fig.height=5, fig.width=6, message=FALSE, warning=FALSE, cache=TRUE}
library(quantmod)
library(rvest)
sp500 <- read_html("https://en.wikipedia.org/wiki/List_of_S%26P_500_companies")

sp500 %>% 
html_nodes(".text") %>% 
html_text() -> ticker_sp500

SP500_symbol <- ticker_sp500[(1:499)*2+1]
SP500_symbol[SP500_symbol == "BRK.B"] <- "BRK-B"
SP500_symbol[SP500_symbol == "BF.B"] <- "BF-B"


today <- Sys.Date()
three_year_ago <- seq(today, length = 2, by = "-3 year")[2]
getSymbols(SP500_symbol, from = three_year_ago, to = today)

nb_sym <- length(SP500_symbol)

omega_invest <- var_invest <- mean_invest <- matrix(NA, nb_sym, nb_sym)
dimnames(omega_invest) <- dimnames(var_invest) <- dimnames(mean_invest) <- list(SP500_symbol, SP500_symbol)

for (i in 1:(nb_sym-1)){
  for (j in (i+1):nb_sym){
    stock1 <- get(SP500_symbol[i])
    stock2 <- get(SP500_symbol[j])
    
    Ra <- na.omit(ClCl(stock1))
    Rn <- na.omit(ClCl(stock2)) 
    
    # Estimation of mu and Sigma
    Sigma <- cov(cbind(Ra, Rn))
    mu <- c(mean(Ra), mean(Rn))
    
    # Compute omega^*
    omega_invest[i, j] <- omega_star <- (Sigma[2, 2] - Sigma[1, 2])/(Sigma[1, 1] + Sigma[2, 2] - 2*Sigma[1, 2])
    
    # Compute investment expected value and variance
    mean_invest[i, j] <- omega_star*mu[1] + (1 - omega_star)*mu[2]
    var_invest[i, j] <- omega_star^2*Sigma[1,1] + (1 - omega_star)^2*Sigma[2,2] + 
    2*omega_star*(1 - omega_star)*Sigma[1,2]
  }
}

var_graph <- sqrt(na.omit(as.vector(var_invest)))
exp_graph <- na.omit(as.vector(mean_invest))
omega_graph <- na.omit(as.vector(omega_invest))
cond <- omega_graph < 0.6 & omega_graph > 0.4
risk_possible = var_graph[cond]
exp_possible = exp_graph[cond]
min_risk = which.min(risk_possible)

col_possible = hcl(h = seq(15, 375, length = 3), l = 65, c = 100, alpha = 0.1)[2]
col_possible_leg = hcl(h = seq(15, 375, length = 3), l = 65, c = 100, alpha = 0.4)[2]
col_best = hcl(h = seq(15, 375, length = 3), l = 65, c = 100, alpha = 1)[1]

plot(NA, xlim = range(risk_possible), 
ylim = range(exp_possible), 
xlab = "Investement Daily Risk",
ylab = "Investement Daily Expected Returns")
grid()
points(risk_possible, exp_possible, pch = 16, col = col_possible[1])
points(risk_possible[min_risk], exp_possible[min_risk], pch = 16, col = col_best[1])

legend("topright", c("Possible portfolio","Min-variance portfolio"),
pch = 16, col = c(col_possible_leg[1], col_best[1]),
bty = "n")
```

To help complete this task your boss tells you to use **3 years** of historical data and gives you this code to download the data you will need:

```{r, eval=FALSE, message=FALSE, warning=FALSE, cache = TRUE}
library(quantmod)
library(rvest)
sp500 <- read_html("https://en.wikipedia.org/wiki/List_of_S%26P_500_companies")

sp500 %>% 
html_nodes(".text") %>% 
html_text() -> ticker_sp500

SP500_symbol <- ticker_sp500[(1:499)*2+1]
SP500_symbol[SP500_symbol == "BRK.B"] <- "BRK-B"
SP500_symbol[SP500_symbol == "BF.B"] <- "BF-B"


today <- Sys.Date()
three_year_ago <- seq(today, length = 2, by = "-3 year")[2]
getSymbols(SP500_symbol, from = three_year_ago, to = today)
```

He also mentioned that the function `get()` could be useful for this project and provides you with the example below: 

```{r, message=FALSE, warning=FALSE, cache = TRUE}
library(quantmod)
today <- Sys.Date()
three_year_ago <- seq(today, length = 2, by = "-3 year")[2]
stocks_tickers <- c("AAPL", "MSFT")
getSymbols(stocks_tickers, from = three_year_ago, to = today)
nb_ticker <- length(stocks_tickers)
var_stocks <- rep(NA, nb_ticker)
names(var_stocks) <- stocks_tickers

for (i in 1:nb_ticker){
Xt = na.omit(ClCl(get(stocks_tickers[i])))
stocks_tickers[i] = var(Xt)
}
stocks_tickers
```
